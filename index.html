<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchMaster Pro - Advanced Fuzzy Matching</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            margin-bottom: 30px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #667eea10, #764ba210);
            transform: translateY(-2px);
        }

        .upload-box.dragover {
            border-color: #4CAF50;
            background: #4CAF5010;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 15px;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .settings-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #333;
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .setting-input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .setting-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .weight-info {
            font-size: 0.8em;
            color: #888;
            margin-top: 4px;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-weight: 500;
        }

        .results-section {
            display: none;
        }

        .results-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
        }

        .download-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .matches-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .match-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .match-item:last-child {
            border-bottom: none;
        }

        .match-source, .match-target {
            display: flex;
            flex-direction: column;
        }

        .match-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .match-artist {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .match-writer {
            color: #888;
            font-size: 0.85em;
            font-style: italic;
        }

        .match-score {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">🎯 MatchMaster Pro</div>
            <div class="tagline">Advanced Fuzzy Matching for Data Excellence</div>
        </div>

        <div class="main-card">
            <div class="upload-section">
                <div class="upload-box" id="internalUpload">
                    <div class="upload-icon">📊</div>
                    <div class="upload-text">Upload Internal Catalog</div>
                    <div style="font-size: 0.9em; color: #999;">Drop Excel/CSV file here or click to browse</div>
                    <input type="file" class="file-input" id="internalFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="internalInfo" style="display: none;"></div>
                </div>

                <div class="upload-box" id="blackboxUpload">
                    <div class="upload-icon">🔍</div>
                    <div class="upload-text">Upload Black Box Data</div>
                    <div style="font-size: 0.9em; color: #999;">Drop Excel/CSV file here or click to browse</div>
                    <input type="file" class="file-input" id="blackboxFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="blackboxInfo" style="display: none;"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">⚙️ Matching Settings</div>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label class="setting-label">Match Threshold (%)</label>
                        <input type="number" class="setting-input" id="threshold" value="50" min="0" max="100">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Close Match Threshold (%)</label>
                        <input type="number" class="setting-input" id="closeThreshold" value="40" min="0" max="100">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Title Weight</label>
                        <input type="number" class="setting-input" id="titleWeight" value="0.4" min="0" max="1" step="0.1">
                        <div class="weight-info">Importance of song title matching</div>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Artist Weight</label>
                        <input type="number" class="setting-input" id="artistWeight" value="0.35" min="0" max="1" step="0.1">
                        <div class="weight-info">Importance of artist matching</div>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Writer Weight</label>
                        <input type="number" class="setting-input" id="writerWeight" value="0.25" min="0" max="1" step="0.1">
                        <div class="weight-info">Importance of writer/songwriter matching</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="startMatching" disabled>
                    🚀 Start Matching
                </button>
                <button class="btn btn-secondary" id="clearFiles">
                    🗑️ Clear Files
                </button>
            </div>

            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Initializing...</div>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-card">
                <div class="results-header">
                    <div class="results-title">📈 Matching Results</div>
                    <button class="download-btn" id="downloadBtn">
                        ⬇️ Download CSV
                    </button>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMatches">0</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="highConfidence">0</div>
                        <div class="stat-label">High Confidence</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="mediumConfidence">0</div>
                        <div class="stat-label">Medium Confidence</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="averageScore">0%</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>

                <div class="matches-preview" id="matchesPreview"></div>
            </div>
        </div>

        <div class="footer">
            <p>© 2025 MatchMaster Pro - Powered by Advanced Fuzzy Matching Algorithms</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        class FuzzyMatcher {
            constructor() {
                this.internalData = null;
                this.blackboxData = null;
                this.matches = [];
                this.settings = {
                    threshold: 50,
                    closeThreshold: 40,
                    titleWeight: 0.4,
                    artistWeight: 0.35,
                    writerWeight: 0.25
                };
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // File upload handlers
                document.getElementById('internalFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e, 'internal');
                });

                document.getElementById('blackboxFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e, 'blackbox');
                });

                // Drag and drop handlers
                this.setupDragAndDrop('internalUpload', 'internalFile');
                this.setupDragAndDrop('blackboxUpload', 'blackboxFile');

                // Button handlers
                document.getElementById('startMatching').addEventListener('click', () => {
                    this.startMatching();
                });

                document.getElementById('clearFiles').addEventListener('click', () => {
                    this.clearFiles();
                });

                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadResults();
                });

                // Settings change handlers
                ['threshold', 'closeThreshold', 'titleWeight', 'artistWeight', 'writerWeight'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        this.settings[id] = parseFloat(e.target.value);
                        this.validateWeights();
                    });
                });
            }

            validateWeights() {
                const totalWeight = this.settings.titleWeight + this.settings.artistWeight + this.settings.writerWeight;
                if (Math.abs(totalWeight - 1.0) > 0.01) {
                    console.warn(`Warning: Total weights sum to ${totalWeight.toFixed(2)}, consider adjusting for optimal results`);
                }
            }

            setupDragAndDrop(uploadBoxId, fileInputId) {
                const uploadBox = document.getElementById(uploadBoxId);
                const fileInput = document.getElementById(fileInputId);

                uploadBox.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadBox.classList.add('dragover');
                });

                uploadBox.addEventListener('dragleave', () => {
                    uploadBox.classList.remove('dragover');
                });

                uploadBox.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadBox.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        this.handleFileUpload({target: fileInput}, uploadBoxId.replace('Upload', ''));
                    }
                });

                uploadBox.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            async handleFileUpload(event, type) {
                const file = event.target.files[0];
                if (!file) return;

                const fileInfo = document.getElementById(type + 'Info');
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `📄 ${file.name} (${this.formatFileSize(file.size)})`;

                try {
                    const data = await this.parseFile(file);
                    if (type === 'internal') {
                        this.internalData = data;
                    } else {
                        this.blackboxData = data;
                    }

                    this.updateStartButton();
                    this.showSuccess(`${type === 'internal' ? 'Internal Catalog' : 'Black Box Data'} loaded successfully: ${data.length} records`);
                } catch (error) {
                    this.showError(`Error loading ${type} file: ${error.message}`);
                }
            }

            async parseFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            let data;
                            
                            if (file.name.endsWith('.csv')) {
                                data = this.parseCSV(e.target.result);
                            } else {
                                const workbook = XLSX.read(e.target.result, {type: 'binary'});
                                const sheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[sheetName];
                                data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                                data = this.convertArrayToObjects(data);
                            }
                            
                            resolve(data);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    
                    if (file.name.endsWith('.csv')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsBinaryString(file);
                    }
                });
            }

            parseCSV(text) {
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        data.push(row);
                    }
                }
                
                return data;
            }

            convertArrayToObjects(arrayData) {
                if (arrayData.length === 0) return [];
                
                const headers = arrayData[0];
                const data = [];
                
                for (let i = 1; i < arrayData.length; i++) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = arrayData[i][index] || '';
                    });
                    data.push(row);
                }
                
                return data;
            }

            updateStartButton() {
                const startBtn = document.getElementById('startMatching');
                startBtn.disabled = !this.internalData || !this.blackboxData;
            }

            clearFiles() {
                this.internalData = null;
                this.blackboxData = null;
                this.matches = [];
                
                document.getElementById('internalFile').value = '';
                document.getElementById('blackboxFile').value = '';
                document.getElementById('internalInfo').style.display = 'none';
                document.getElementById('blackboxInfo').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'none';
                
                this.updateStartButton();
                this.hideError();
            }

            async startMatching() {
                this.showProgress();
                this.hideError();
                
                try {
                    await this.performMatching();
                    this.showResults();
                } catch (error) {
                    this.showError(`Matching failed: ${error.message}`);
                } finally {
                    this.hideProgress();
                }
            }

            async performMatching() {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                progressText.textContent = 'Processing data...';
                progressFill.style.width = '10%';
                
                const matches = [];
                const totalComparisons = this.blackboxData.length;
                
                for (let i = 0; i < this.blackboxData.length; i++) {
                    const blackboxRecord = this.blackboxData[i];
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    for (const internalRecord of this.internalData) {
                        const score = this.calculateMatchScore(blackboxRecord, internalRecord);
                        if (score > bestScore) {
                            bestScore = score;
                            bestMatch = internalRecord;
                        }
                    }
                    
                    if (bestScore >= this.settings.threshold) {
                        matches.push({
                            blackboxRecord,
                            internalRecord: bestMatch,
                            score: bestScore,
                            confidence: bestScore >= 80 ? 'high' : 'medium'
                        });
                    }
                    
                    // Update progress
                    const progress = ((i + 1) / totalComparisons) * 90 + 10;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `Matching records: ${i + 1}/${totalComparisons}`;
                    
                    // Allow UI to update
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
                
                progressFill.style.width = '100%';
                progressText.textContent = 'Matching complete!';
                
                this.matches = matches;
            }

            calculateMatchScore(blackboxRecord, internalRecord) {
                // Get possible field names for title, artist, and writer
                const titleFields = ['title', 'Title', 'reported title', 'Reported Title', 'song', 'Song', 'track', 'Track'];
                const artistFields = ['artist', 'Artist', 'reported artist', 'Reported Artist', 'performer', 'Performer'];
                const writerFields = ['writer', 'Writer', 'writers', 'Writers', 'songwriter', 'Songwriter', 'composer', 'Composer', 'author', 'Author'];
                
                const bbTitle = this.getFieldValue(blackboxRecord, titleFields);
                const bbArtist = this.getFieldValue(blackboxRecord, artistFields);
                const bbWriter = this.getFieldValue(blackboxRecord, writerFields);
                
                const intTitle = this.getFieldValue(internalRecord, titleFields);
                const intArtist = this.getFieldValue(internalRecord, artistFields);
                const intWriter = this.getFieldValue(internalRecord, writerFields);
                
                const titleScore = this.fuzzyMatch(bbTitle, intTitle);
                const artistScore = this.fuzzyMatch(bbArtist, intArtist);
                const writerScore = this.fuzzyMatch(bbWriter, intWriter);
                
                // Calculate weighted score
                const totalScore = (titleScore * this.settings.titleWeight) + 
                                 (artistScore * this.settings.artistWeight) + 
                                 (writerScore * this.settings.writerWeight);
                
                return Math.min(100, totalScore);
            }

            getFieldValue(record, possibleFields) {
                for (const field of possibleFields) {
                    if (record[field]) {
                        return this.cleanText(record[field]);
                    }
                }
                return '';
            }

            cleanText(text) {
                if (!text) return '';
                return text.toString().toLowerCase().trim().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ');
            }

            fuzzyMatch(str1, str2) {
                if (!str1 || !str2) return 0;
                
                // Exact match
                if (str1 === str2) return 100;
                
                // Levenshtein distance based similarity
                const distance = this.levenshteinDistance(str1, str2);
                const maxLength = Math.max(str1.length, str2.length);
                const similarity = (1 - distance / maxLength) * 100;
                
                // Token-based matching for better results
                const tokens1 = str1.split(' ').filter(t => t.length > 0);
                const tokens2 = str2.split(' ').filter(t => t.length > 0);
                
                let commonTokens = 0;
                for (const token1 of tokens1) {
                    for (const token2 of tokens2) {
                        if (token1 === token2 || this.levenshteinDistance(token1, token2) <= 1) {
                            commonTokens++;
                            break;
                        }
                    }
                }
                
                const tokenSimilarity = (commonTokens * 2) / (tokens1.length + tokens2.length) * 100;
                
                return Math.max(similarity, tokenSimilarity);
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }

            showResults() {
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                
                const highConfidence = this.matches.filter(m => m.confidence === 'high').length;
                const mediumConfidence = this.matches.filter(m => m.confidence === 'medium').length;
                const averageScore = this.matches.length > 0 ? 
                    Math.round(this.matches.reduce((sum, m) => sum + m.score, 0) / this.matches.length) : 0;
                
                document.getElementById('totalMatches').textContent = this.matches.length;
                document.getElementById('highConfidence').textContent = highConfidence;
                document.getElementById('mediumConfidence').textContent = mediumConfidence;
                document.getElementById('averageScore').textContent = averageScore + '%';
                
                this.renderMatchesPreview();
            }

            renderMatchesPreview() {
                const preview = document.getElementById('matchesPreview');
                preview.innerHTML = '';
                
                const sortedMatches = [...this.matches].sort((a, b) => b.score - a.score
